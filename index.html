<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./css/leaflet.css"/>
    <link rel="stylesheet" href="./css/bootstrap.min.css"/>
    <script src="./js/leaflet.js"></script>
    <script src="./js/leaflet.ajax.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/config.js"></script>
    
    <!-- var tl_2021_45-->
    <script src="./GeoJSON/tl_2021_45_tract.js"></script>
    <style>
    #map {
        position: relative;
        border: 1px solid black;
        border-radius: 8px;
        height: 400px;
        width: 100%;  
      }
    </style>   
</head>
<body>
    <div class="container-fluid p-4 bg-primary text-white text-center">
        <h1>2020 Census Maps</h1>
        <p>South Carolina, Census API Demo</p> 
    </div>

    <div class="container mt-5">
        <div class="row">
          <div class="col-sm-4">
            <input type="button" class="btn btn-success" value="Send Request to Census" onclick="getpop()">
            <textarea class="form-control" rows="5" id="textAreaResponse"></textarea>
            <a href="https://api.census.gov/data/2020/dec/pl/variables.html" class="btn btn-info" role="button">Variable Dictionary (Census)</a>          
          </div>
          <div class="col-sm-8">
            <div id="map"></div>
          </div>
          
         </div>
    </div>



<script>

var map = L.map('map').setView([34, -81], 10);
let censusDict = {};

let censusVariables = ["P1_001N", "P1_003N", "P1_004N", "P1_005N", "P1_006N", "P1_007N", "P1_008N"] ; // total population
let censusURL = "https://api.census.gov/data/2020/dec/pl?get=NAME,"; //2020 redistricting

let fetchURL;
let geoidClick;
let stateClick;
let countyClick;
let tractClick;

// add tiles
var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiamRoaWJiZXJ0IiwiYSI6ImNrejdyYXFnZjBtZm8yb21wYTBtdzlsd2cifQ.sw9Ly8ks5nkQ2WmucBvBVQ', {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
        'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1
});
tiles.addTo(map);

// return tract color/syle
function tractStyle(feature) {
  return {  
    color: '#B04173'
  };
}



// add geojson tracks
var tractsLayer = new L.geoJSON(tl_2021_45,{
  style: tractStyle,
  onEachFeature: onEachFeature
});                  
tractsLayer.addTo(map);

// bind functions to each geojson feature
function onEachFeature(feature, layer) {
    //show geoid for now...
      layer.bindPopup(feature.properties.GEOID);
      layer.on({ 
                  mouseover: featureHover, 
                  mouseout: resetHighlight,
                  click: featureClick
              });
}
// highlight when mouse over tract
function featureHover(e) {
    
    var layer = e.target;

    layer.setStyle({
        weight: 5,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.7
    });

    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
    }
    
}

// remove highlight when mouse moves off tract
function resetHighlight(e) {
  tractsLayer.resetStyle(e.target);
}

function featureClick(e) {
  document.getElementById("textAreaResponse").innerHTML = "";
  geoidClick = e.target.feature.properties.GEOID;
  stateClick = geoidClick.slice(0, 2);
  countyClick = geoidClick.slice(2, 5);
  tractClick = geoidClick.slice(5, 12);
  document.getElementById("textAreaResponse").innerHTML = geoidClick + " : " +  stateClick + " : " + countyClick + " : " + tractClick;
  

}

async function getpop() {
  document.getElementById("textAreaResponse").innerHTML = "";
  for (let i=0; i < censusVariables.length; i++) {
    fetchURL = censusURL + censusVariables[i] + "&for=tract:" + tractClick + "&in=state:" + stateClick + "%20county:" + countyClick + "&key=" + KEY;
    console.log(fetchURL);
    let response = await fetch(fetchURL);
    let data = await response.text();
    try {
        let rows = await JSON.parse(data);  // convert to array
        document.getElementById("textAreaResponse").innerHTML += rows[0][1] + ": " + rows[1][1] + "\n";
        
        } catch(error) {
        document.getElementById("textAreaResponse").innerHTML = "API error retrieving variable for " + geoidClick;    
        }
    }
    
  }
  
  

</script>

