

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./css/leaflet.css"/>
    <link rel="stylesheet" href="./css/bootstrap.min.css"/>
    <script src="./js/leaflet.js"></script>
    <script src="./js/leaflet.ajax.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/config.js"></script>
    
    <!-- var tl_2021_45-->
    <script src="./GeoJSON/tl_2021_45_tract.js"></script>
    <style>
    #map {
        position: relative;
        border: 1px solid black;
        border-radius: 8px;
        height: 400px;
        width: 100%;  
      }
    </style>   
</head>
<body>
    <div class="container-fluid p-4 bg-primary text-white text-center">
        <h1>2020 Census Maps</h1>
        <p>South Carolina, Census API, Leaflet, GeoJSON Demo</p> 
    </div>

    <div class="container-fluid d-flex h-100 flex-column">
      <div class="row mt-2 flex-grow-1">
        <div class="col-sm-4">
          <textarea class="form-control" rows="12" id="textAreaResponse"></textarea>
          <input type="button" class="btn btn-success" value="Send Request to Census" onclick="getpop()">
          <a href="https://api.census.gov/data/2020/dec/pl/variables.html" class="btn btn-info" role="button">Variable Dictionary (Census)</a>          
        </div>
        <div class="col-sm-8">
          <div id="map"></div>
        </div>         
      </div>
    </div>



<script>

var map = L.map('map').setView([34, -81], 10);
let censusDict = {};
let censusGroup = ["group(P1)"];
let censusVariables = ["P1_001N", "P1_003N", "P1_004N", "P1_005N", "P1_006N", "P1_007N", "P1_008N"]; // total population
//let censusURL = "https://api.census.gov/data/2020/dec/pl?get=NAME,"; //2020 redistricting
let censusURL = "https://api.census.gov/data/2020/dec/pl?get="; //2020 redistricting

let fetchURL;
let geoidClick;
let stateClick;
let countyClick;
let tractClick;

// add tiles
var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiamRoaWJiZXJ0IiwiYSI6ImNrejdyYXFnZjBtZm8yb21wYTBtdzlsd2cifQ.sw9Ly8ks5nkQ2WmucBvBVQ', {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
        'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1
});
tiles.addTo(map);

// return tract color/syle
function tractStyle(feature) {
  return {  
    color: '#B04173'
  };
}



// add geojson tracks
var tractsLayer = new L.geoJSON(tl_2021_45,{
  style: tractStyle,
  onEachFeature: onEachFeature
});                  
tractsLayer.addTo(map);

// bind functions to each geojson feature
function onEachFeature(feature, layer) {
    //show geoid for now...
      layer.bindPopup(feature.properties.GEOID);
      layer.on({ 
                  mouseover: featureHover, 
                  mouseout: resetHighlight,
                  click: featureClick
              });
}
// highlight when mouse over tract
function featureHover(e) {
    
    var layer = e.target;

    layer.setStyle({
        weight: 5,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.7
    });

    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
    }
    
}

// remove highlight when mouse moves off tract
function resetHighlight(e) {
  tractsLayer.resetStyle(e.target);
}

function featureClick(e) {
  document.getElementById("textAreaResponse").innerHTML = "";
  geoidClick = e.target.feature.properties.GEOID;
  stateClick = geoidClick.slice(0, 2);
  countyClick = geoidClick.slice(2, 5);
  tractClick = geoidClick.slice(5, 12);
  document.getElementById("textAreaResponse").innerHTML = geoidClick + " : " +  stateClick + " : " + countyClick + " : " + tractClick;
  

}

function getIndexFromVariableName(varName, censusArray) {
  let idx = -1;
  for(i = 0; i < censusArray[0].length; i++) {
    if (censusArray[0][i] == varName) {
      idx = i;
    }
  }
  return idx;
}

async function getpop() {
  document.getElementById("textAreaResponse").innerHTML = "";
  let totPop;
  for (let i=0; i < censusGroup.length; i++) {

      fetchURL = censusURL + censusGroup[i] + "&for=tract:" + tractClick + "&in=state:" + stateClick + "%20county:" + countyClick + "&key=" + KEY;
    
      let response = await fetch(fetchURL);
      let data = await response.text();
      let rows = await JSON.parse(data);
      document.getElementById("textAreaResponse").innerHTML += rows[1][1] + "\n"; // tract name + info
      totPop = rows[1][2];

      for(let j = 0; j < censusVariables.length; j++){
        let idx = getIndexFromVariableName(censusVariables[j], rows);
        if (idx > 0) {
          let pct = (rows[1][idx] / totPop * 100).toFixed(2);
          document.getElementById("textAreaResponse").innerHTML += rows[0][idx] + ": " + rows[1][idx] + " (" + pct + ")\n";        
        }        
      }
    }
  }
  
</script>




